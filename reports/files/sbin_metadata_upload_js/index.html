<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - sbin/metadata_upload.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>sbin/metadata_upload.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">71.71</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">464</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">46.24</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">3.00</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">// metadata_upload.js

/**
* Read csv into an object
* get field/column names and info into custom_metadata_fields (mixs_field_description)
* Convert &#039;sample_name&#039;, &#039;ANONYMIZED_NAME&#039;, &#039;DESCRIPTION&#039;, &#039;TAXON_ID&#039;, &#039;common_name&#039;, &#039;title&#039; into dataset_id
* Put data into required_metadata_info
* create a custom metadata table, using project_id, custom_metadata_fields and the additional columns info
* The object should have methods:
*   get required field names from db (for now from constants)
*   get required field info from csv
*   get custom field names etc. from csv
*   put custom field names into db
*   put required info in db
*   create a custom table for this project
*   put custom info in db
 ===
* Call as node sbin/metadata_upload.js csv_file_path
* All database specific things are in models/csv_metadata_upload.js
*/


var helpers = require(&#039;../routes/helpers/helpers&#039;);

var csvMetadataUpload = require(&#039;../models/csv_metadata_upload.js&#039;);
var csv_metadata_db = new csvMetadataUpload();

connection = require(&#039;../config/database-dev&#039;);

var fs = require(&#039;fs&#039;);
var parse = require(&#039;csv-parse&#039;);
var constants = require(&#039;../public/constants&#039;);

var req_fields = constants.REQ_METADATA_FIELDS;


var fields_to_replace = [&#039;sample_name&#039;, &#039;ANONYMIZED_NAME&#039;, &#039;title&#039;];


var metadata_dict_by_pr_dataset = {};


function usage()
{
  console.log(&quot;This script puts metadata in the Qiita format into the database.&quot;);
  console.log(&quot;It adds data to required_metadata_info and custom_metadata_fields&quot;);
  console.log(&quot;and creates a custom metadata table per project (like &#039;custom_metadata_18&#039;)&quot;);
  console.log(&quot;Please provide a path to a csv file in the command line.&quot;);
  console.log(&quot;Example: node sbin/metadata_upload.js ./data/KCK_LSM_Bv6_qii.csv&quot;);
}

function get_csv_filename()
{
  // var my_args = process.argv.slice(2);
  
  if (process.argv.length === 3)
  {
    return process.argv[2];    
  }
  else
  {
    usage();
    process.exit(0);
  }
}

var input = fs.createReadStream(get_csv_filename());
// todo: use in transform pipe, close when done
// https://github.com/wdavidw/node-csv-parse
// input.on(&#039;finish&#039;, function() {
//   console.log(&#039;ok: csv metadata&#039;);
//   // this.end();
//   
//   // return handler(null);
//   // return null;
// });

parser_hash = parse({columns: true}, function(err, data){
  do_smth_w_data_hash(data);  
});

Array.prototype.diff = function(a) {
    return this.filter(function(i) {return a.indexOf(i) &lt; 0;});
};

// todo: move to helper, use also in custom_taxa_class.js
function add_to_dict(dict, key, value)
{
  if (!(dict[key]))
  {
    dict[key] = [];
  }
  dict[key].push(value);
  return dict;
}

function make_metadata_dict_by_project(csv_data_hash)
{
  var metadata_dict_by_project = {};

  for (var i = 0; csv_data_hash.length &gt; i; i += 1) {
    var project = csv_data_hash[i][&#039;title&#039;];
    metadata_dict_by_project = add_to_dict(metadata_dict_by_project, project, csv_data_hash[i]);
  }
  return metadata_dict_by_project;
}

function correct_dataset_name(dataset)
{
   return dataset.replace(/\./g,&quot;_&quot;);
}

function make_dict_by_project_datasets(csv_data_hash)
{

  var project_datasets = {};

  for(var row_obj in csv_data_hash)
  {
    var project = csv_data_hash[row_obj][&#039;title&#039;];
    var dataset = csv_data_hash[row_obj][&#039;sample_name&#039;];
    if (dataset !== undefined)
    {
      dataset = correct_dataset_name(dataset);
    }
    if (project !== undefined)
    {
      project_datasets = add_to_dict(project_datasets, project, dataset); 
    }
  }
  return project_datasets;
}

// * get custom field names etc. from csv

function get_custom_columns_from_csv(csv_data_hash)
{
  var column_names = Object.keys(csv_data_hash[0]);
  var not_req_column_names = column_names.diff(req_fields);
  var custom_column_names = not_req_column_names.diff(fields_to_replace);

  return custom_column_names;
}

function get_custom_column_examples_from_csv(metadata_dict_by_project, custom_column_names)
{
  var custom_column_examples = {};
  for (var project in metadata_dict_by_project)
  {
    // console.log(&quot;555&quot;);
    // console.log(metadata_dict_by_project[project]);
    custom_column_examples[project] = [];
    for (var u = 0, len = custom_column_names.length; u &lt; len; u++)
    {
      column_name = custom_column_names[u];
      custom_column_examples[project][column_name] = metadata_dict_by_project[project][0][column_name];
    }
  }
  return custom_column_examples;
}

function work_with_ids_from_db(project_datasets, metadata_dict_by_project)
{
  // console.log(&quot;000000&quot;);
  // console.log(project_datasets);
  // console.log(&quot;111111&quot;);

  for (var project in project_datasets)
  {
    if ((project !== undefined) &amp;&amp; (project !== &quot;undefined&quot;))
    {
      
      var datasets = &quot;&#039;&quot; + project_datasets[project].join(&quot;&#039;, &#039;&quot;) + &quot;&#039;&quot;;
      csv_metadata_db.get_dataset_ids(project, datasets, function work_with_dataset_id(err, results)
      {
        if (err)
          throw err; // or return an error message, or something
        else
        {
          // todo: add ids to dict, use for custom and requireds
          metadata_dict_by_project_w_ids = update_metadata_dict_by_project(results, metadata_dict_by_project);

          insert_into_custom_fields_txt = format_custom_metadata_fields_info(metadata_dict_by_project_w_ids[project]);
          call_insert_custom_fields_into_db(insert_into_custom_fields_txt);          
          insert_into_required_metadata_info_txt = format_required_metadata_info(metadata_dict_by_project_w_ids[project].metadata);
          call_insert_required_fields_into_db(insert_into_required_metadata_info_txt);
          make_custom_table(metadata_dict_by_project_w_ids[project]);          
        }
      });
    }
    // else
    // {
    //   console.log(&quot;8888 =====&quot;);
    //   console.log(&quot;project&quot;);
    //   console.log(project);
    //   
    // }
  }
}

function add_ids_to_metadata(db_ids, metadata_from_csv)
{
  for (var k = 0; metadata_from_csv.length &gt; k; k += 1)
  {
    sample_name = correct_dataset_name(metadata_from_csv[k].sample_name);
    res = get_this_dataset(db_ids, sample_name);
    if (res[0] &amp;&amp; (metadata_from_csv[k][&quot;title&quot;] === res[0].project))
    {
      metadata_from_csv[k].project_id = res[0].project_id;
      metadata_from_csv[k].dataset_id = res[0].dataset_id;
      metadata_from_csv[k].correct_dataset_name = sample_name;
    }
  }
  return metadata_from_csv;
}

function update_metadata_dict_by_project(db_id_results, metadata_dict_by_project)
{
  var metadata_dict_by_project_w_ids = {};
  for (var project in metadata_dict_by_project)
  {
    if (metadata_dict_by_project[project])
    {
      var metadata_arr_by_project = add_ids_to_metadata(db_id_results, metadata_dict_by_project[project]);
      var res = get_this_project(db_id_results, project);

      metadata_dict_by_project_w_ids[project] = {project_id: res[0].project_id, metadata: metadata_arr_by_project};
    }
  }
  return metadata_dict_by_project_w_ids;
}


function get_this_project(db_ids, project)
{
  return db_ids.filter(function(obj) {
      return (obj.project === project);
  });
}

function get_this_dataset(db_ids, dataset)
{
  return db_ids.filter(function(obj) {
    return (obj.dataset === dataset);
  });
}


function call_insert_custom_fields_into_db(insert_into_custom_fields_txt)
{
  csv_metadata_db.insert_custom_field_names(insert_into_custom_fields_txt, function insert_db(err, results)
  {
    if (err)
      throw err; // or return an error message, or something
    else
    {
      console.log(&quot;insert_custom_field_names results&quot;);
      console.log(results);
    }
  });
}

function format_custom_metadata_fields_info(metadata_by_project_w_ids)
{
  var insert_into_custom_fields_txt = [];
  var project = metadata_by_project_w_ids.metadata[0][&quot;title&quot;];
  var project_id = metadata_by_project_w_ids.project_id;
  for (var i = 0; custom_column_names.length &gt; i; i += 1)
  {
      var field_name = custom_column_names[i].toLowerCase();
      var example = custom_column_examples[project][field_name];
      var into_db = project_id + &quot;, &#039;&quot; + field_name + &quot;&#039;, &#039;&quot; + example + &quot;&#039;&quot;;
      insert_into_custom_fields_txt.push(into_db);
  }
  // console.log(&quot;SSSSS&quot;);
  // console.log(insert_into_custom_fields_txt);

  return insert_into_custom_fields_txt;
}

function custom_fields(csv_data_hash, metadata_dict_by_project)
{
  custom_column_names = get_custom_columns_from_csv(csv_data_hash);
  // console.log(&quot;OOO custom_column_names&quot;);
  // console.log(custom_column_names);
  custom_column_examples = get_custom_column_examples_from_csv(metadata_dict_by_project, custom_column_names);
  // console.log(&quot;custom_column_examples 333&quot;);
  // console.log(custom_column_examples);
}

function get_comma(i)
{
  comma = &quot;, &quot;;
  if (i === 0) 
    comma = &quot;&quot;;
  return comma;
}

// * put required info in db
function combine_required_data(this_entry)
{
  // console.log(&quot;RRR req_fields:&quot;);
  // console.log(req_fields);
  
  var into_db = &quot;&quot;;
  var quote = &quot;&#039;&quot;;
  for (var i = 0; req_fields.length &gt; i; i += 1)
  {
    var value = &quot;&quot;;
    value = this_entry[req_fields[i]];
    if (req_fields[i] === &quot;collection_date&quot;)
    {
      value = correct_db_data(this_entry[req_fields[i]]);
    }
    into_db += get_comma(i) + quote + value + quote;
  }  
  return into_db;
}

function format_required_metadata_info(metadata_dict_w_ids)
{
  var insert_into_required_metadata_info_txt = [];
  for (var i = 0; metadata_dict_w_ids.length &gt; i; i += 1)
  {
    var this_entry = metadata_dict_w_ids[i];
    var dataset = this_entry.correct_dataset_name;
    var dataset_id = this_entry.dataset_id;
    if (dataset_id !== undefined)
    {
      // var into_db = combine_required_data(this_entry);
      var into_db = dataset_id + &quot;, &quot; + combine_required_data(this_entry);
      // var altitude = this_entry[&quot;altitude&quot;];
      // var assigned_from_geo = this_entry[&quot;assigned_from_geo&quot;];
      // var collection_date = &quot;&quot;;
      // // if (this_entry[&quot;collection_date&quot;] != &quot;unknown&quot;)
      // // {
      //   collection_date = correct_db_data(this_entry[&quot;collection_date&quot;]);
      // // }
      // var depth = this_entry[&quot;depth&quot;];
      // var country = this_entry[&quot;country&quot;];
      // var elevation = this_entry[&quot;elevation&quot;];
      // var env_biome = this_entry[&quot;env_biome&quot;];
      // var env_feature = this_entry[&quot;env_feature&quot;];
      // var env_matter = this_entry[&quot;env_matter&quot;];
      // var latitude = this_entry[&quot;latitude&quot;];
      // var longitude = this_entry[&quot;longitude&quot;];
      // var is_public = this_entry[&quot;public&quot;];
      // 
      // var into_db = dataset_id + &quot;, &quot; + altitude + &quot;, &#039;&quot; + assigned_from_geo + &quot;&#039;, &#039;&quot; + collection_date + &quot;&#039;, &quot; + depth + &quot;, &#039;&quot; + country + &quot;&#039;, &quot; + elevation + &quot;, &#039;&quot; + env_biome + &quot;&#039;, &#039;&quot; + env_feature + &quot;&#039;, &#039;&quot; + env_matter + &quot;&#039;, &quot; + latitude + &quot;, &quot; + longitude + &quot;, &quot; + temp + &quot;, &quot; + salinity + &quot;, &quot; + diss_oxygen + &quot;, &#039;&quot; + is_public + &quot;&#039;&quot;;
      insert_into_required_metadata_info_txt.push(into_db);
    }
    else
    {
      console.log(&quot;ERROR: Add this dataset to db: &quot; + this_entry.sample_name);
    }
  }
  return insert_into_required_metadata_info_txt;
}

function call_insert_required_fields_into_db(insert_into_required_metadata_info_txt)
{
  csv_metadata_db.insert_required_field_names(req_fields, insert_into_required_metadata_info_txt, function insert_db(err, results)
  {
    if (err)
      throw err; // or return an error message, or something
    else
    {
      console.log(&quot;insert_required_field_names results&quot;);
      console.log(results);
    }
  });
}

function correct_db_data(collection_date)
{
  var d = new Date(Date.parse(collection_date));
  return d.toISOString().replace(/T.+/, &#039;&#039;);
}

/* create a custom table for this project
 * read data from custom_metadata_fields
 * create table
 * put in data from csv
*/

function make_custom_table(project_metadata_dict_w_ids)
{
  var project_id = project_metadata_dict_w_ids.project_id;
  var metadata = project_metadata_dict_w_ids.metadata;
  var table_name = &quot;custom_metadata_&quot; + project_id;    
  csv_metadata_db.select_custom_fields_names(project_id, function get_custom_fields_names(err, custom_fields_names)
  {
    call_make_custom_table_per_pr(custom_fields_names, project_id, table_name);
    custom_fields_names_arr = format_custom_fields_names(custom_fields_names, metadata);
    call_insert_into_custom_metadata_info(metadata, table_name, custom_fields_names_arr);
  });
}

function call_make_custom_table_per_pr(custom_fields_names, project_id, table_name)
{
  csv_metadata_db.make_custom_table_per_pr(custom_fields_names, project_id, function create_custom_table(err, results)
  {
    if (err)
      throw err; // or return an error message, or something
    else
    {
      if (results.warningCount === 1)
      {
        console.log(&quot;Warning: Please check &quot; + table_name + &quot; table, it seems to exist already.&quot;);
      }
    }
  });
}

function call_insert_into_custom_metadata_info(project_metadata_dict_w_ids, table_name, custom_fields_names_arr)
{
  csv_metadata_db.insert_into_custom_metadata_per_pr(project_metadata_dict_w_ids, table_name, custom_fields_names_arr, function insert_into_custom_metadata(err, results)
  {
    if (err)
      throw err; // or return an error message, or something
    else
    {
      console.log(&quot;insert_into_custom_metadata_info: &quot;);
      console.log(results);      
    }
  });
}


function collect_custom_fields_names_into_arr(custom_fields_names)
{
  var custom_fields_names_arr = [];
  for (var k = 0; custom_fields_names.length &gt; k; k += 1)
  {
    field_name = custom_fields_names[k].field_name;
    custom_fields_names_arr.push(field_name);
  }
  return custom_fields_names_arr;
}

function format_custom_fields_names(custom_fields_names)
{
  var custom_fields_names_arr = collect_custom_fields_names_into_arr(custom_fields_names);
  custom_fields_names_arr.unshift(&quot;dataset_id&quot;);
  custom_fields_names_arr.unshift(&quot;project_id&quot;);
  
  return custom_fields_names_arr;
}

function to_lower_case(csv_data_hash_raw)
{
  var csv_data_hash = [];
  for (var i = 0; csv_data_hash_raw.length &gt; i; i += 1)
  {
    var temp_hash = {};
    // console.log(&quot;===== DDDD &quot;);
    // console.log(i);
    // console.log(&quot;csv_data_hash_raw[i]&quot;);
    // console.log(csv_data_hash_raw[i]);
    for (var key in csv_data_hash_raw[i])
    {
      temp_hash[key.toLowerCase()] = csv_data_hash_raw[i][key];
    }          
    csv_data_hash[i] = temp_hash;
  }
  return csv_data_hash;
}

function do_smth_w_data_hash(csv_data_hash_raw)
{
  // console.log(&quot;===== HHH &quot;);
  // console.log(&quot;csv_data_hash&quot;);
  // console.log(csv_data_hash);
  var csv_data_hash = to_lower_case(csv_data_hash_raw);
  var metadata_dict_by_project = make_metadata_dict_by_project(csv_data_hash);

  var project_datasets = make_dict_by_project_datasets(csv_data_hash);

  custom_fields(csv_data_hash, metadata_dict_by_project);
  work_with_ids_from_db(project_datasets, metadata_dict_by_project);  
}

// input.pipe(parser);

// http://nicolashery.com/parse-data-files-using-nodejs-streams/
input.pipe(parser_hash);
// .pipe(process.stdout);
// input.push(null);  

// connection.destroy( );</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
